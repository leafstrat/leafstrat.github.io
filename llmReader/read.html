<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Model Viewer</title> <!-- This will be replaced by JavaScript -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f9f9f9;
    }
    pre {
      background: #eee;
      padding: 1em;
      overflow: auto;
      transition: outline 0.2s ease, box-shadow 0.2s ease; /* For nav-active transition */
    }
    .message-container {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      transition: background-color 0.2s ease, max-height 0.3s ease;
      max-height: 200px;
      overflow: hidden;
      position: relative;
      margin-left:70px;
    }

    .message-expanded {
      max-height: none;
    }

    .expand-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 3px 8px;
      border-radius: 3px 0 0 0;
      font-size: 12px;
      cursor: pointer;
    }

    .fade-bottom {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      /* Fades to the body background color */
      background: linear-gradient(to bottom, rgba(249,249,249,0), rgba(249,249,249,0.9));
      pointer-events: none;
    }

    /* Active navigation item styles */
    .message-container.nav-active {
      background-color: #e0f0ff;
    }
    pre.nav-active {
      outline: 2px solid #28a745;
      box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
    }

	.counter_holder {
		position: fixed;
		top: 20px;
		left: 10px;
		width: 60px;
		display: flex;
		justify-content: center;
	}
    .counter {
      color: white;
      padding: 5px 10px;
      font-size: 14px;
      z-index: 100;
      border-radius: 15px;
      background-color: rgba(0,0,0,0.7);
    }
    .custom-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      transition: opacity 0.3s;
      opacity: 0;
      z-index: 1000;
      pointer-events: none;
    }
    .custom-notification.show {
      opacity: 1;
    }
    .loading {padding-left:80px;
    font-size:62px;
    }
    /* Add cursor to indicate clickability for navigable items */
    .message-container[data-nav-id], pre[data-nav-id] {
        cursor: pointer;
    }
  </style>
</head>
<body>
	<div class="counter_holder">
		<div class="counter" id="counter">0/0</div>
  </div>
  <div id="content"><div class="loading">Loading...</div></div>
  <div class="custom-notification" id="custom-notification-fallback"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return document.getElementById('content').textContent = 'Missing ?id=...';
      const url = `https://files.catbox.moe/${id}.json`;
      const contentContainer = document.getElementById('content');

      try {
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`Failed to fetch: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();

        document.title = data.chatTitle && data.chatTitle.trim() !== "" ? data.chatTitle.trim() : 'Model Viewer';
        contentContainer.innerHTML = ''; // clear "Loading..."

        if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") console.log("Notification permission granted.");
                else console.log("Notification permission denied.");
            });
        }

        const navigableItems = [];
        let globalNavIdCounter = 0;

        if (data.modelMessages && Array.isArray(data.modelMessages)) {
            for (const md of data.modelMessages) {
              const wrapper = document.createElement('div');
              wrapper.className = 'message-container';
              wrapper.innerHTML = marked.parse(md);

              const messageNavId = `nav-item-${globalNavIdCounter++}`;
              wrapper.dataset.navId = messageNavId;
              navigableItems.push({ element: wrapper, type: 'message', id: messageNavId });

              const expandIndicator = document.createElement('div');
              expandIndicator.className = 'expand-indicator';
              expandIndicator.textContent = '⤢';
              wrapper.appendChild(expandIndicator);

              const fadeBottom = document.createElement('div');
              fadeBottom.className = 'fade-bottom';
              wrapper.appendChild(fadeBottom);

              expandIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                if (wrapper.scrollHeight > 200) {
                    wrapper.classList.toggle('message-expanded');
                    expandIndicator.textContent = wrapper.classList.contains('message-expanded') ? '⤡' : '⤢';
                    fadeBottom.style.display = wrapper.classList.contains('message-expanded') ? 'none' : 'block';
                    if (wrapper.classList.contains('message-expanded')) {
                        const currentNavItem = navigableItems[currentIndex];
                        if (currentNavItem && (currentNavItem.element === wrapper || currentNavItem.parentMessageContainer === wrapper)) {
                           setTimeout(() => scrollToItem(currentIndex, false), 50);
                        }
                    }
                }
              });

              setTimeout(() => {
                if (wrapper.scrollHeight <= 200) {
                  expandIndicator.style.display = 'none';
                  fadeBottom.style.display = 'none';
                }
              }, 0);

              const codeBlocks = wrapper.querySelectorAll('pre');
              codeBlocks.forEach(preElement => {
                const codeBlockNavId = `nav-item-${globalNavIdCounter++}`;
                preElement.dataset.navId = codeBlockNavId;
                navigableItems.push({
                    element: preElement,
                    type: 'codeblock',
                    parentMessageContainer: wrapper,
                    id: codeBlockNavId
                });
              });
              contentContainer.appendChild(wrapper);
            }
        } else {
            contentContainer.textContent = 'No messages found or data format is incorrect.';
            console.error('data.modelMessages is missing or not an array:', data);
            return;
        }

        document.querySelectorAll('pre code').forEach(block => {
          hljs.highlightElement(block);
        });

        let currentIndex = 0;
        const totalNavigable = navigableItems.length;
        updateCounter();

        if (totalNavigable > 0) {
          highlightItem(currentIndex);
          // Optionally scroll to the first item on load, without forcing expand unless necessary
          // scrollToItem(currentIndex, false);
        }

        document.addEventListener('keydown', (event) => {
          if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            navigateNext();
          } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            navigatePrevious();
          } else if (event.key === 'c' || event.key === 'C') {
            event.preventDefault();
            copyCurrentItem();
          } else if (event.key === ' ') {
            event.preventDefault();
            toggleExpandCurrent();
          }
        });

        contentContainer.addEventListener('click', (e) => {
            let targetElement = e.target;
            let navId = null;

            while (targetElement && targetElement !== contentContainer) {
                if (targetElement.dataset && targetElement.dataset.navId) {
                    if (targetElement.classList.contains('message-container')) {
                        const expandIndicator = targetElement.querySelector('.expand-indicator');
                        if (e.target === expandIndicator) return; // Clicked on expand indicator, handled by its own listener
                    }
                    navId = targetElement.dataset.navId;
                    break;
                }
                targetElement = targetElement.parentElement;
            }

            if (navId) {
                const newIndex = navigableItems.findIndex(item => item.id === navId);
                if (newIndex !== -1) {
                    currentIndex = newIndex;
                    highlightItem(currentIndex);
                    updateCounter();
                    // scrollToItem(currentIndex, false); // Optional: scroll into view on click
                }
            }
        });

        function navigateNext() {
          if (currentIndex < totalNavigable - 1) {
            currentIndex++;
            highlightItem(currentIndex);
            updateCounter();
            scrollToItem(currentIndex, true);
          }
        }

        function navigatePrevious() {
          if (currentIndex > 0) {
            currentIndex--;
            highlightItem(currentIndex);
            updateCounter();
            scrollToItem(currentIndex, true);
          }
        }

        function highlightItem(index) {
          navigableItems.forEach(item => {
            item.element.classList.remove('nav-active');
          });
          if (navigableItems[index]) {
            navigableItems[index].element.classList.add('nav-active');
          }
        }

        function updateCounter() {
          if (totalNavigable > 0) {
            document.getElementById('counter').textContent = `${currentIndex + 1}/${totalNavigable}`;
          } else {
            document.getElementById('counter').textContent = `0/0`;
          }
        }

        function scrollToItem(index, forceExpand = false) {
            if (index < 0 || index >= totalNavigable || !navigableItems[index]) return;

            const item = navigableItems[index];
            const elementToScrollTo = item.element;
            let parentMessageContainer = item.type === 'codeblock' ? item.parentMessageContainer : (item.type === 'message' ? item.element : null);

            if (parentMessageContainer && !parentMessageContainer.classList.contains('message-expanded')) {
                let needsExpand = false;
                // If item is a code block within a collapsible (and currently collapsed implied by !message-expanded) container
                if (item.type === 'codeblock' && parentMessageContainer.scrollHeight > 200) {
                    needsExpand = true;
                }
                // If forceExpand is true for a message container itself that is collapsible
                if (forceExpand && item.type === 'message' && parentMessageContainer.scrollHeight > 200) {
                     needsExpand = true;
                }

                if (needsExpand) {
                    parentMessageContainer.classList.add('message-expanded');
                    const expandIndicator = parentMessageContainer.querySelector('.expand-indicator');
                    if (expandIndicator) expandIndicator.textContent = '⤡';
                    const fadeBottom = parentMessageContainer.querySelector('.fade-bottom');
                    if (fadeBottom) fadeBottom.style.display = 'none';

                    setTimeout(() => { // Allow DOM to reflow after expansion
                        const rect = elementToScrollTo.getBoundingClientRect();
                        const offset = 30;
                        if (rect.top < offset || rect.bottom > window.innerHeight - (offset / 2) ) {
                             window.scrollTo({ top: window.pageYOffset + rect.top - offset, behavior: 'smooth' });
                        }
                    }, 60);
                    return; // Exit after initiating expansion and scroll
                }
            }

            // Standard scroll if no expansion was needed or occurred
            const rect = elementToScrollTo.getBoundingClientRect();
            const offset = 30;
            if (rect.top < offset || rect.bottom > window.innerHeight - (offset / 2) ) {
                 window.scrollTo({ top: window.pageYOffset + rect.top - offset, behavior: 'smooth' });
            }
        }

        function copyCurrentItem() {
          if (currentIndex >= 0 && currentIndex < totalNavigable) {
            const currentItem = navigableItems[currentIndex];
            let textToCopy = "";
            let notificationTitle = "";

            if (currentItem.type === 'codeblock') {
              const codeElement = currentItem.element.querySelector('code');
              textToCopy = codeElement ? codeElement.textContent : currentItem.element.textContent;
              notificationTitle = "Code block copied!";
            } else if (currentItem.type === 'message') {
              textToCopy = currentItem.element.innerText || currentItem.element.textContent.trim();
              notificationTitle = "Message copied!";
            }

            if (textToCopy) {
              navigator.clipboard.writeText(textToCopy)
                .then(() => {
                  const firstLine = textToCopy.split('\n')[0].substring(0, 100) + (textToCopy.split('\n')[0].length > 100 ? '...' : '');
                  showBrowserNotification(notificationTitle, firstLine);
                })
                .catch(err => {
                  console.error('Failed to copy: ', err);
                  showBrowserNotification("Copy Failed", "Could not copy text to clipboard.", true);
                });
            }
          }
        }

        async function showBrowserNotification(title, bodyText, isError = false) {
          const notificationBody = bodyText || (isError ? "Please check console for details." : "Content copied.");
          if (!("Notification" in window)) {
            showCustomFallbackNotification(title, notificationBody);
            return;
          }
          if (Notification.permission === "granted") {
            new Notification(title, { body: notificationBody, icon: '/favicon.ico' });
          } else if (Notification.permission !== "denied") {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              new Notification(title, { body: notificationBody, icon: '/favicon.ico' });
            } else {
              showCustomFallbackNotification(title, notificationBody);
            }
          } else {
            showCustomFallbackNotification(title, notificationBody);
          }
        }

        function showCustomFallbackNotification(message, firstLine) {
          const notificationElement = document.getElementById('custom-notification-fallback');
          if (notificationElement) {
            notificationElement.innerHTML = `<strong>${message}</strong><br><span style="font-size: smaller;">${firstLine || ''}</span>`;
            notificationElement.classList.add('show');
            setTimeout(() => {
              notificationElement.classList.remove('show');
            }, 3000);
          }
        }

        function toggleExpandCurrent() {
          if (currentIndex < 0 || currentIndex >= totalNavigable) return;
          const currentItem = navigableItems[currentIndex];
          let messageContainerToExpand;

          if (currentItem.type === 'codeblock') {
            messageContainerToExpand = currentItem.parentMessageContainer;
          } else if (currentItem.type === 'message') {
            messageContainerToExpand = currentItem.element;
          }

          if (messageContainerToExpand && messageContainerToExpand.scrollHeight > 200) {
            messageContainerToExpand.classList.toggle('message-expanded');
            const expandIndicator = messageContainerToExpand.querySelector('.expand-indicator');
            const fadeBottom = messageContainerToExpand.querySelector('.fade-bottom');
            if (expandIndicator) {
              expandIndicator.textContent = messageContainerToExpand.classList.contains('message-expanded') ? '⤡' : '⤢';
            }
            if (fadeBottom) {
              fadeBottom.style.display = messageContainerToExpand.classList.contains('message-expanded') ? 'none' : 'block';
            }
            if (messageContainerToExpand.classList.contains('message-expanded')) {
              // Ensure the currently selected item (which might be child code block) is visible
              setTimeout(() => scrollToItem(currentIndex, false), 50);
            }
          }
        }

      } catch (e) {
        contentContainer.textContent = `Error loading or parsing JSON: ${e.message}`;
        console.error(e);
        document.title = 'Error Loading Chat';
      }
    })();
  </script>
</body>
</html>
